### MoE 流程

#### 1. 门控打分，给 token 匹配专家

- 线性映射，将 token 语义与专家偏好做匹配（得分越高，适配度越强）

#### 2. 选择 Top-N 适配专家

- 对每个 token 的专家得分排序，选择前 N 个得分最高的专家，得到 “选中专家得分” 和 “专家 ID”；并对选中专家得分归一化，得分越高，专家权重越大

#### 3. 专家去重

- 提取所有 token 选中的 “不重复专家 ID”，避免遍历所有专家导致算力浪费

#### 4. 专家对专属 token 加工

- 每个专家通过独立的 SwiGLU-FFN 处理 “选了它的 token”

#### 5. 融合多专家输出

- 专家输出 × 对应权重，得到专家贡献度，将所有选中专家的输出加权求和
